#!/bin/env bash
values_dotfile="$HOME/.tmp_values.json"

function get_network_interfaces {
    for intf in $(ifconfig | rg -wo "eth[0-9]|wlan[0-9]|tun[0-9]"); do
        intf_ip=$(ifconfig $intf | rg -w 'inet' | awk '{print $2}')

        if [[ $intf_ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
            array_test+=($intf)
        fi
    done

    echo -n ${array_test[@]}
}

function get_intf_prms {
    intf_ip=$(ifconfig ${1} | rg -w 'inet' | awk '{print $2}')
    intf_ip_g=`echo $intf_ip | cut -d"." -f1-3`.1

    echo -n "\"${1}_ip\": \"${intf_ip}\", \"${1}_g\": \"${intf_ip_g}\", "
}

function form_j_str {
    all_intf=$(get_network_interfaces)

    for intf in ${all_intf[@]}; do
        j_str+=$(get_intf_prms $intf)
    done

    echo -n ${j_str::-2}
}

function ip_status {
    ping -c 1 -W 0.5 ${1} > /dev/null 2>&1; [[ $? -eq 0 ]] && echo -n "UP" || echo -n "DOWN"
}

function parse_field {
    echo -n $(jq ". | to_entries | map(select(.key | match(\"${1}\"))) | map(.value)" $values_dotfile | tr -d '\[\],\"')
}

function print_options {
    echo 'Localhost addresses:'
    for intf in $(get_network_interfaces); do 
        echo $intf
        echo -e "\tip: $(parse_field ${intf}_ip)"
        echo -e "\tgateway: $(parse_field ${intf}_g)"
    done

    targets=$(parse_field target)
    if [[ ! -z $targets ]]; then
        echo 'Targets:'
        for ip in $targets; do
            echo -e "\t$ip $(ip_status $ip)"
        done
    fi

    ports=$(parse_field port)
    if [[ ! -z $ports ]]; then
        echo 'Ports:'
        for port in $ports; do
            echo -e "\t$port"
        done
    fi
}

# TODO: <21-06-21, modernpacifist>
# this must update file, not overwrite it
if [[ ! -f ${values_dotfile} ]]; then
    echo "{ $(form_j_str) }" | jq . > ${values_dotfile}
else
    echo "File was parsed"
    # file must be updated here 
fi

print_options
